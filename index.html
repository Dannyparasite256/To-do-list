<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Include jsPDF for PDF export of the recent multipliers -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aviator</title>
  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
    body {
      background: #1a1a1a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    
    .container {
      width: 400px;
      max-width: 90%;
      background: #2b2b2b;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      text-align: center;
      margin-bottom: 20px;
    }
    
    /* Account Header with Balance Container and Action Buttons */
    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background: #333;
      border-radius: 10px;
    }
    
    .account-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .account-icon {
      font-size: 24px;
    }
    
    .balance-container {
      padding: 5px 10px;
      background: #444;
      border-radius: 5px;
    }
    
    .balance-text {
      font-size: 18px;
      font-weight: bold;
    }
    
    .account-actions {
      display: flex;
      gap: 10px;
    }
    
    #deposit-btn,
    #withdraw-btn {
      background: #0080ff;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    
    #deposit-btn:hover,
    #withdraw-btn:hover {
      background: #006bb3;
    }
    
    /* Countdown Timer */
    .round-timer {
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    /* Game Area Styles */
    .game-area {
      position: relative;
      margin: 20px auto;
      width: 300px;
      height: 300px;
      border: 2px solid #444;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle, #333, #1a1a1a);
      overflow: hidden;
    }
    
    .multiplier-display {
      font-size: 48px;
      font-weight: bold;
      position: absolute;
      top: 40%;
      transform: translateY(-50%);
      z-index: 2;
    }
    
    .airplane {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 36px;
    }
    
    /* Real-time potential winnings display */
    .winnings {
      margin-top: 10px;
      font-size: 24px;
      font-weight: bold;
    }
    
    /* Controls arranged horizontally */
    .controls {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    
    .bet-input {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .bet-input input {
      width: 100px;
      padding: 8px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
    }
    
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      background: #0080ff;
      color: #fff;
      white-space: nowrap;
    }
    
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    
    .next-crash {
      margin-top: 10px;
      font-size: 16px;
    }
    
    .result {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }
    
    /* Result colors */
    .win {
      color: #00ff00;
    }
    
    .loss {
      color: #ff4444;
    }
    
    /* Virtual Players (Live Bets) Section */
    .virtual-players {
      width: 400px;
      max-width: 90%;
      background: #2b2b2b;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      text-align: left;
      margin-bottom: 20px;
    }
    
    .virtual-players h3 {
      margin-top: 0;
      font-size: 20px;
      text-align: center;
    }
    
    .virtual-players ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .virtual-players li {
      margin: 5px 0;
      font-size: 16px;
    }
    
    /* Recent Multipliers Section (Horizontal Format) */
    .recent-multipliers {
      width: 400px;
      max-width: 90%;
      background: #2b2b2b;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      text-align: left;
      margin-bottom: 20px;
    }
    
    .recent-multipliers h3 {
      margin-top: 0;
      font-size: 20px;
      text-align: center;
    }
    
    .recent-multipliers ul {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .recent-multipliers li {
      margin-right: 10px;
      font-size: 16px;
      white-space: nowrap;
    }
    
    /* Loading Spinner Styles */
    #loading-spinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0080ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Mobile Responsiveness: Cover entire screen and remove extra margins */
    @media (max-width: 600px) {
      .container,
      .virtual-players,
      .recent-multipliers {
        width: 100%;
        max-width: 100%;
        border-radius: 0;
        margin: 0;
        padding: 15px;
        min-height: 100vh;
      }
      body {
        padding: 0;
        margin: 0;
      }
      .game-area {
        width: 90vw;
        height: 90vw;
        max-width: none;
        max-height: none;
      }
      /* Adjust text sizes for better readability */
      .multiplier-display {
        font-size: 36px;
      }
      .airplane {
        font-size: 28px;
      }
      .winnings {
        font-size: 20px;
      }
      .balance-text {
        font-size: 16px;
      }
      #deposit-btn, #withdraw-btn {
        font-size: 12px;
        padding: 6px 10px;
      }
      button {
        font-size: 14px;
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Account Header with Balance and Action Buttons -->
    <div class="account-header">
      <div class="account-info">
        <span class="account-icon">üë§</span>
        <div class="balance-container">
          <span class="balance-text">Balance: UGX <span id="balance">100,000.00</span></span>
        </div>
      </div>
      <div class="account-actions">
        <button id="deposit-btn">Deposit</button>
        <button id="withdraw-btn">Withdraw</button>
      </div>
    </div>
    
    <!-- Countdown Timer for the Next Round -->
    <div class="round-timer">
      Next round starts in: <span id="countdown-timer">10</span> seconds
    </div>
    
    <!-- Central Game Area -->
    <div class="game-area">
      <div class="multiplier-display" id="multiplier">1.00x</div>
      <div class="airplane" id="airplane">‚úàÔ∏è</div>
    </div>
    
    <!-- Real-Time Potential Winnings -->
    <div class="winnings">Potential Winnings: UGX <span id="winnings">0.00</span></div>
    
    <!-- Controls arranged horizontally -->
    <div class="controls">
      <div class="bet-input">
        <label for="bet-amount">Bet: UGX</label>
        <input type="number" id="bet-amount" min="1" value="10000" />
      </div>
      <button id="place-bet-btn">Place Bet</button>
      <button id="start-btn">Start Round Now</button>
      <button id="cashout-btn" disabled>Cash Out</button>
    </div>
    
    <div class="next-crash">Next Crash: <span id="next-crash">?</span>x</div>
    <div class="result" id="result"></div>
  </div>
  
  <!-- Virtual Players / Live Bets Section -->
  <div class="virtual-players">
    <h3>Live Bets</h3>
    <ul id="players-list">
      <!-- Virtual players will be updated here -->
    </ul>
  </div>
  
  <!-- Recent Multipliers Section (Horizontal) -->
  <div class="recent-multipliers">
    <h3>Recent Multipliers</h3>
    <ul id="multipliers-list">
      <!-- The last 100 multiplier values will be listed here horizontally -->
    </ul>
    <button id="save-pdf-btn">Save as PDF</button>
  </div>
  
  <!-- Loading Spinner for Withdrawal Process -->
  <div id="loading-spinner">
    <div class="spinner"></div>
  </div>
  
  <script>
    // Global Variables
    let balance = 100000;  // UGX
    let multiplier = 1.0;
    let simulationInterval;  // Interval for simulation updates
    let roundCountdownInterval; // Interval for round countdown
    let roundCountdownTime = 10; // seconds
    let crashed = false;
    let currentBet = 0;
    let nextCrashMultiplier = generateCrashMultiplier();
    let hasCashedOut = false;
    let userParticipating = false; // indicates if the user is joining the round
    let betAlreadyPlaced = false;  // indicates if bet has already been deducted
    let lockedMultiplier = 0;      // used when cashing out

    // Array to store last 100 recent multipliers
    let recentMultipliers = [];

    // DOM Elements
    const balanceDisplay = document.getElementById('balance');
    const multiplierDisplay = document.getElementById('multiplier');
    const airplane = document.getElementById('airplane');
    const winningsDisplay = document.getElementById('winnings');
    const betAmountInput = document.getElementById('bet-amount');
    const placeBetBtn = document.getElementById('place-bet-btn');
    const startBtn = document.getElementById('start-btn');
    const cashoutBtn = document.getElementById('cashout-btn');
    const depositBtn = document.getElementById('deposit-btn');
    const withdrawBtn = document.getElementById('withdraw-btn');
    const nextCrashDisplay = document.getElementById('next-crash');
    const resultDisplay = document.getElementById('result');
    const playersList = document.getElementById('players-list');
    const countdownTimerDisplay = document.getElementById('countdown-timer');
    const loadingSpinner = document.getElementById('loading-spinner');
    const multipliersList = document.getElementById('multipliers-list');
    const savePdfBtn = document.getElementById('save-pdf-btn');

    // Function to format numbers as currency with commas.
    function formatCurrency(amount) {
      return amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Show and hide loading spinner functions
    function showLoadingSpinner() {
      loadingSpinner.style.display = 'block';
    }
    function hideLoadingSpinner() {
      loadingSpinner.style.display = 'none';
    }

    // Generate a random crash multiplier using the fair distribution:
    // P(m ‚â• x) = 1/x for x ‚â• 1, capped at 100,000.
    function generateCrashMultiplier() {
      const maxMultiplier = 100000;
      const u = Math.random() * (1 - 1 / maxMultiplier);
      const m = 1 / (1 - u);
      return parseFloat(m.toFixed(2));
    }

    // Update the real-time potential winnings display (if participating)
    function updateWinnings() {
      if (userParticipating) {
        const potential = currentBet * multiplier;
        winningsDisplay.textContent = potential.toFixed(2);
      }
    }

    // Update the Recent Multipliers list UI (horizontal format with two decimals)
    function updateMultipliersList() {
      multipliersList.innerHTML = "";
      // Display the most recent multipliers first, formatted to 2 decimal places
      for (let i = recentMultipliers.length - 1; i >= 0; i--) {
        const li = document.createElement("li");
        li.textContent = Number(recentMultipliers[i]).toFixed(2);
        multipliersList.appendChild(li);
      }
    }

    // Unified function to start a round.
    function startRoundProcess() {
      if (userParticipating && betAlreadyPlaced) {
        cashoutBtn.disabled = false;
      } else {
        userParticipating = false;
        currentBet = 0;
        cashoutBtn.disabled = true;
      }

      // Reset simulation variables and UI.
      crashed = false;
      multiplier = 1.0;
      hasCashedOut = false;
      resultDisplay.textContent = '';
      resultDisplay.classList.remove("win", "loss");
      multiplierDisplay.textContent = `${multiplier.toFixed(2)}x`;
      winningsDisplay.textContent = userParticipating ? (currentBet * multiplier).toFixed(2) : "0.00";
      
      // Reset airplane position.
      airplane.style.bottom = `10%`;
      
      startBtn.disabled = true;
      placeBetBtn.disabled = true;
      clearInterval(roundCountdownInterval);
      countdownTimerDisplay.textContent = "0";

      // --- Updated Multiplier Distribution ---
      // Using an exponential growth function:
      //   multiplier = exp(elapsed / growthConstant)
      // Crash occurs when multiplier >= nextCrashMultiplier.
      const growthConstant = 3; // adjust to change growth speed (seconds)
      const roundStartTime = Date.now();
      
      simulationInterval = setInterval(() => {
        const elapsed = (Date.now() - roundStartTime) / 1000; // seconds elapsed
        multiplier = Math.exp(elapsed / growthConstant);
        multiplierDisplay.textContent = `${multiplier.toFixed(2)}x`;
        if (userParticipating) updateWinnings();

        // Animate airplane upward proportionally.
        const container = document.querySelector('.game-area');
        const containerHeight = container.offsetHeight;
        const airplaneHeight = airplane.offsetHeight;
        const maxBottomPercent = ((containerHeight - airplaneHeight) / containerHeight) * 100;
        let progress = (multiplier - 1) / (nextCrashMultiplier - 1);
        if (progress > 1) progress = 1;
        const newBottom = 10 + progress * (maxBottomPercent - 10);
        airplane.style.bottom = `${newBottom}%`;

        // Check for crash.
        if (multiplier >= nextCrashMultiplier) {
          crash();
        }
      }, 50);
      // --- End Updated Code ---
    }

    // Cash out function for the user.
    function cashOut() {
      if (!userParticipating || hasCashedOut || crashed) return;
      lockedMultiplier = multiplier;
      hasCashedOut = true;
      const winnings = currentBet * lockedMultiplier;
      balance += winnings;
      balanceDisplay.textContent = formatCurrency(balance);
      resultDisplay.innerHTML = `Cashed out at ${lockedMultiplier.toFixed(2)}x! You won UGX <span>+${winnings.toFixed(2)}</span>!`;
      resultDisplay.classList.remove("loss");
      resultDisplay.classList.add("win");
      cashoutBtn.disabled = true;
    }

    // Crash the round.
    function crash() {
      crashed = true;
      clearInterval(simulationInterval);
      
      // Record the final multiplier of the round (rounded to 2 decimals).
      const recordedMultiplier = hasCashedOut ? lockedMultiplier : parseFloat(multiplier.toFixed(2));
      recentMultipliers.push(recordedMultiplier);
      if (recentMultipliers.length > 100) {
        recentMultipliers.shift();
      }
      updateMultipliersList();
      
      resultDisplay.innerHTML = !hasCashedOut
        ? `Crashed at ${multiplier.toFixed(2)}x! You lost UGX <span>-${currentBet.toFixed(2)}</span>.`
        : `Cashed out at ${lockedMultiplier.toFixed(2)}x! Round crashed at ${multiplier.toFixed(2)}x.`;
      resultDisplay.classList.remove(hasCashedOut ? "loss" : "win");
      resultDisplay.classList.add(hasCashedOut ? "win" : "loss");
      startBtn.disabled = false;
      cashoutBtn.disabled = true;
      
      userParticipating = false;
      betAlreadyPlaced = false;
      placeBetBtn.disabled = false;

      nextCrashMultiplier = generateCrashMultiplier();
      nextCrashDisplay.textContent = nextCrashMultiplier;
      
      setTimeout(startCountdown, 3000);
    }

    // Countdown function.
    function startCountdown() {
      roundCountdownTime = 4;
      countdownTimerDisplay.textContent = roundCountdownTime;
      roundCountdownInterval = setInterval(() => {
        roundCountdownTime--;
        countdownTimerDisplay.textContent = roundCountdownTime;
        if (roundCountdownTime <= 0) {
          clearInterval(roundCountdownInterval);
          startRoundProcess();
        }
      }, 1000);
    }

    // Manual start.
    startBtn.addEventListener('click', () => {
      clearInterval(roundCountdownInterval);
      startRoundProcess();
    });

    // Cash Out button event.
    cashoutBtn.addEventListener('click', cashOut);

    // Withdraw Button event with loading animation and success prompt.
    withdrawBtn.addEventListener('click', () => {
      const withdrawAmount = prompt("Enter withdrawal amount (UGX):");
      const amount = parseFloat(withdrawAmount);
      if (!isNaN(amount) && amount > 0 && amount <= balance) {
        showLoadingSpinner();
        setTimeout(() => {
          hideLoadingSpinner();
          balance -= amount;
          balanceDisplay.textContent = formatCurrency(balance);
          alert(`Withdrawal of UGX ${amount.toFixed(2)} successful! Please check your mobile money account.`);
        }, 2000);
      } else {
        alert("Invalid withdrawal amount!");
      }
    });

    // Deposit Button event.
    depositBtn.addEventListener('click', () => {
      const depositAmount = prompt("Enter deposit amount (UGX):");
      const amount = parseFloat(depositAmount);
      if (!isNaN(amount) && amount > 0) {
        balance += amount;
        balanceDisplay.textContent = formatCurrency(balance);
        alert(`Deposit of UGX ${amount.toFixed(2)} successful!`);
      } else {
        alert("Invalid deposit amount!");
      }
    });

    // "Place Bet" button event.
    placeBetBtn.addEventListener('click', () => {
      if (!betAlreadyPlaced) {
        const betAmount = parseFloat(betAmountInput.value);
        if (betAmount > balance || betAmount <= 0) {
          alert("Invalid bet amount!");
          return;
        }
        currentBet = betAmount;
        balance -= currentBet;
        balanceDisplay.textContent = formatCurrency(balance);
        userParticipating = true;
        betAlreadyPlaced = true;
        placeBetBtn.disabled = true;
        cashoutBtn.disabled = false;
      }
    });

    // Save Multipliers as PDF event.
    savePdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(12);
      doc.text("Recent Multipliers", 10, 10);
      let y = 20;
      recentMultipliers.forEach((mult, index) => {
        doc.text(`${index + 1}. ${Number(mult).toFixed(2)}`, 10, y);
        y += 10;
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });
      doc.save('recent_multipliers.pdf');
    });

    // Start the initial round countdown.
    startCountdown();
    nextCrashDisplay.textContent = nextCrashMultiplier;
  </script>
</body>
</html>
